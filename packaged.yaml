AWSTemplateFormatVersion: '2010-09-09'
Description: 'Builds serverless API with Lambda functions, API Gateway, SQS Queue,
  DynamoDB table, and S3 bucket.

  '
Globals:
  Function:
    Environment:
      Variables:
        QUEUE_URL:
          Ref: IotDemoQueue
        TABLE_NAME:
          Ref: IotDemoTable
    Timeout: 3
Outputs:
  GetMessagesApi:
    Description: API Gateway endpoint URL for Prod Stage for GetMessagesFunction
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/getMessages/
  IotDemoQueueUrl:
    Description: URL of SQS Queue
    Value:
      Ref: IotDemoQueue
Parameters:
  IotBucketName:
    Default: gstafford-iot-data
    Type: String
Resources:
  GetMessageFunction:
    Description: Get one IoT message based on timestamp and location
    Properties:
      CodeUri: s3://gstafford-sam-demo/1b22a8dbb540ec45046b242577fa2ad9
      Description: Get one IoT message based on timestamp and location
      Events:
        getMessages:
          Properties:
            Method: get
            Path: /message/{date}
          Type: Api
      Handler: app.getMessage
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: IotDemoTable
      Runtime: nodejs10.x
    Type: AWS::Serverless::Function
  GetMessagesFunction:
    Description: Get all IoT messages in DynamoDB table (scan)
    Properties:
      CodeUri: s3://gstafford-sam-demo/1b22a8dbb540ec45046b242577fa2ad9
      Description: Get all IoT messages in DynamoDB table (scan)
      Events:
        getMessages:
          Properties:
            Method: get
            Path: /message
          Type: Api
      Handler: app.getMessages
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: IotDemoTable
      Runtime: nodejs10.x
    Type: AWS::Serverless::Function
  IotDataBucket:
    DependsOn:
    - S3ToSQSFunctionPermission
    Properties:
      BucketName:
        Ref: IotBucketName
      NotificationConfiguration:
        LambdaConfigurations:
        - Event: s3:ObjectCreated:*
          Filter:
            S3Key:
              Rules:
              - Name: suffix
                Value: .csv
          Function:
            Fn::GetAtt:
            - S3ToSQSFunction
            - Arn
    Type: AWS::S3::Bucket
  IotDemoQueue:
    Type: AWS::SQS::Queue
  IotDemoTable:
    Properties:
      AttributeDefinitions:
      - AttributeName: date
        AttributeType: S
      - AttributeName: time
        AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
      - AttributeName: date
        KeyType: HASH
      - AttributeName: time
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 2
        WriteCapacityUnits: 2
    Type: AWS::DynamoDB::Table
  PostMessageFunction:
    Description: Create new IoT message item in DynamoDB table
    Properties:
      CodeUri: s3://gstafford-sam-demo/1b22a8dbb540ec45046b242577fa2ad9
      Description: Create new IoT message item in DynamoDB table
      Events:
        postMessage:
          Properties:
            Method: post
            Path: /message
          Type: Api
      Handler: app.postMessage
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: IotDemoTable
      Runtime: nodejs10.x
    Type: AWS::Serverless::Function
  PutMessageFunction:
    Description: Modify IoT message item in DynamoDB table
    Properties:
      CodeUri: s3://gstafford-sam-demo/1b22a8dbb540ec45046b242577fa2ad9
      Description: Modify new IoT message item in DynamoDB table
      Events:
        putMessage:
          Properties:
            Method: put
            Path: /message
          Type: Api
      Handler: app.putMessage
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: IotDemoTable
      Runtime: nodejs10.x
    Type: AWS::Serverless::Function
  S3ToSQSFunction:
    Description: Respond to S3 Events
    Properties:
      CodeUri: s3://gstafford-sam-demo/bee28601ef49c097e11fac808fd8dbb5
      Description: Post new IoT message to SQS
      Handler: app.lambda_handler
      MemorySize: 256
      Role:
        Fn::GetAtt:
        - S3ToSQSFunctionExecutionRole
        - Arn
      Runtime: python3.7
    Type: AWS::Serverless::Function
  S3ToSQSFunctionExecutionRole:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
        Version: '2012-10-17'
      Policies:
      - PolicyDocument:
          Statement:
          - Action:
            - logs:*
            Effect: Allow
            Resource: arn:aws:logs:*:*:*
          Version: '2012-10-17'
        PolicyName: allowLogging
      - PolicyDocument:
          Statement:
          - Action:
            - s3:GetObject
            Effect: Allow
            Resource:
              Fn::Sub: arn:aws:s3:::${IotBucketName}/*
          Version: '2012-10-17'
        PolicyName: getObjects
      - PolicyDocument:
          Statement:
          - Action:
            - sqs:SendMessage
            Effect: Allow
            Resource:
              Fn::GetAtt:
              - IotDemoQueue
              - Arn
          Version: '2012-10-17'
        PolicyName: produceToQueue
    Type: AWS::IAM::Role
  S3ToSQSFunctionPermission:
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: S3ToSQSFunction
      Principal: s3.amazonaws.com
      SourceAccount:
        Ref: AWS::AccountId
      SourceArn:
        Fn::Sub: arn:aws:s3:::${IotBucketName}
    Type: AWS::Lambda::Permission
  SqsToDynamoDbFunction:
    Description: Post new IoT message to SQS
    Properties:
      CodeUri: s3://gstafford-sam-demo/a3d1993c1bd5bd2ddcb6be699867090e
      Description: Post new IoT message to SQS
      Events:
        SqsToDynamoDb:
          Properties:
            BatchSize: 10
            Enabled: true
            Queue:
              Fn::GetAtt:
              - IotDemoQueue
              - Arn
          Type: SQS
      Handler: app.lambda_handler
      MemorySize: 256
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: IotDemoTable
      Runtime: python3.7
    Type: AWS::Serverless::Function
Transform: AWS::Serverless-2016-10-31
